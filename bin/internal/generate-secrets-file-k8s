#!/bin/bash

cd "$(dirname "$0")/../../kubernetes-manifests"

ENV_VARIABLES=(
    "MONGO_URL"
)

TEMPLATE_FILE="secrets.yml.template"
OUTPUT_FILE="secrets.yml"

main () {
    if ! [ -f "$TEMPLATE_FILE" ]; then
        >&2 echo "Could not find template file ($(pwd)/${TEMPLATE_FILE})"
        exit 1
    fi

    buffer="$(cat "$TEMPLATE_FILE")"

    for var in "${ENV_VARIABLES[@]}"; do
        if [ -z "${!var}" ]; then
            >&2 echo "Missing required env variable: $var"
            exit 1
        fi

        buffer="$(replace_placeholder "$var" "$(base64 -w0 <<< "${!var}")" <<<"$buffer")"
    done

    cat <<<"$buffer" > "$OUTPUT_FILE"
}

replace_placeholder() { 
    sanitized=$(echo -n "$2" | sed -e 's/[\/&]/\\&/g')
    sed "s/\${{ *$1 *}}/${sanitized}/g"
}

main
