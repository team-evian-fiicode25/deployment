#!/bin/bash

cd "$(dirname "$0")"

if [[ $# -eq 0 ]]; then
    delete=0
elif [[ $# -eq 1 ]] && [ "$1" = "apply" ]; then
    delete=0
elif [[ $# -eq 1 ]] && [ "$1" = "delete" ]; then
    delete=1
else
    >&2 echo "Usage: $0 [apply|delete]"
    exit 1
fi

################################
# Get mongo url from terraform #
################################
cd ../terraform
export MONGO_URL="$(terraform output --json documentdb_connection | jq -r '.url')"
cd -

#########################
# Generate secrets file #
#########################
internal/generate-secrets-file-k8s

#######################
# Apply k8s manifests #
#######################
./kubectl-setup

if [ "$delete" -eq 1 ]; then
    kubectl delete -k ../kubernetes-manifests
else
    kubectl apply -k ../kubernetes-manifests
fi
